// ==UserScript==
// @name         Moswar ‚Äî –ë–ª–æ–∫ –∫–ª–∏–∫–æ–≤ –ø–æ –Ω–∏–∫–∞–º –∏ —É—Å–∏–ª–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–æ–≤
// @namespace    moswar-hard-block
// @version      2.0
// @namespace    Linkif
// @description  –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –ø–æ –Ω–∏–∫–∞–º –∏ —É–ª—É—á—à–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–æ–≤
// @match        https://www.moswar.ru/fight/*
// @include      https://*.moswar.ru*
// @include      https://*.moswar.mail.ru*
// @grant        none
// ==/UserScript==

(function() {
  'use strict';

  // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –∫–ª–∏–∫–æ–≤
  const style = document.createElement('style');
  style.textContent = `
    /* –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏–π –±–ª–æ–∫ –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤ */
    .fighter-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 100;
      cursor: pointer;
      background-color: rgba(255,255,255,0); /* –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω */
    }
    
    /* –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—ã–±–æ—Ä–∞ */
    .fighter-selected {
      box-shadow: inset 0 0 0 3px #ffcc80, 0 0 8px #ffcc80;
      background-color: rgba(255, 204, 128, 0.1);
      border-radius: 5px;
    }
    
    /* –°—Ç–∏–ª—å –¥–ª—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–æ–≤ */
    .fighter-disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    
    /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —á–µ–∫–±–æ–∫—Å–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    .fighter-checkbox {
      transform: scale(1.5);
      margin: 8px;
    }
  `;
  document.head.appendChild(style);

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞—Ö
  function createFighterOverlays() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –≤ –≥—Ä—É–ø–ø–æ–≤–æ–º –±–æ—é
    const fightGroups = document.querySelectorAll('.fight-group');
    if (!fightGroups.length) return;
    
    // –ù–∞—Ö–æ–¥–∏–º –≥—Ä—É–ø–ø—É –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–æ–≤ (–æ–±—ã—á–Ω–æ —ç—Ç–æ –≤—Ç–æ—Ä–∞—è –≥—Ä—É–ø–ø–∞)
    const enemyGroup = document.querySelectorAll('.fight-group')[1];
    if (!enemyGroup) return;
    
    // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ –≤ –≥—Ä—É–ø–ø–µ
    const enemyFighters = enemyGroup.querySelectorAll('.fighter');
    enemyFighters.forEach(fighter => {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ —É–∂–µ –æ–≤–µ—Ä–ª–µ–π
      if (fighter.querySelector('.fighter-overlay')) return;
      
      // –ù–∞—Ö–æ–¥–∏–º —á–µ–∫–±–æ–∫—Å –≤—ã–±–æ—Ä–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
      const checkbox = fighter.querySelector('input[type="checkbox"]');
      
      // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º fighter –≤ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
      fighter.style.position = 'relative';
      
      // –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç
      const overlay = document.createElement('div');
      overlay.className = 'fighter-overlay';
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
      overlay.addEventListener('click', function(e) {
        e.stopPropagation();
        e.preventDefault();
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å —á–µ–∫–±–æ–∫—Å, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –µ–≥–æ
        if (checkbox) {
          checkbox.checked = !checkbox.checked;
          
          // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
          if (checkbox.checked) {
            fighter.classList.add('fighter-selected');
          } else {
            fighter.classList.remove('fighter-selected');
          }
          
          // –í—ã–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏–≥—Ä—ã
          const changeEvent = new Event('change', { bubbles: true });
          checkbox.dispatchEvent(changeEvent);
        }
        
        console.log("üëÜ –ü–µ—Ä–µ—Ö–≤–∞—á–µ–Ω –∫–ª–∏–∫ –ø–æ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫—É, –≤—ã–±–æ—Ä –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω");
      });
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–≤–µ—Ä–ª–µ–π –≤ –±–æ–µ—Ü
      fighter.appendChild(overlay);
      
      // –ï—Å–ª–∏ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫ —É–∂–µ –≤—ã–±—Ä–∞–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –≤—ã–¥–µ–ª–µ–Ω–∏—è
      if (checkbox && checkbox.checked) {
        fighter.classList.add('fighter-selected');
      }
      
      // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —á–µ–∫–±–æ–∫—Å–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
      if (checkbox) {
        checkbox.classList.add('fighter-checkbox');
      }
    });
  }
  
  // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–µ—Ä–µ—Ö–æ–¥—ã –ø–æ —Å—Å—ã–ª–∫–∞–º –Ω–∞ –∏–≥—Ä–æ–∫–æ–≤ –≤ –±–æ—é
  document.addEventListener("click", function(e) {
    const a = e.target.closest("a[href^='/player/']");
    const insideFightGroup = e.target.closest(".fight-group");
    
    if (a && insideFightGroup) {
      e.stopImmediatePropagation();
      e.stopPropagation();
      e.preventDefault();
      console.log("üö´ –ö–ª–∏–∫ –ø–æ –Ω–∏–∫—É –≤ –±–æ—é –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.");
    }
  }, true);
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –ø–æ—Å–ª–µ AJAX-–∑–∞–ø—Ä–æ—Å–æ–≤
  function initOverlays() {
    if (window.location.href.includes('/fight/')) {
      createFighterOverlays();
    }
  }
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  document.addEventListener('DOMContentLoaded', initOverlays);
  
  // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è DOM –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  const observer = new MutationObserver(function(mutations) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –±–æ—è
    if (window.location.href.includes('/fight/')) {
      createFighterOverlays();
    }
  });
  
  // –ù–∞–±–ª—é–¥–∞–µ–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  observer.observe(document.body, { 
    childList: true, 
    subtree: true 
  });
  
  // –¢–∞–∫–∂–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∫–æ–Ω–µ—Ü AJAX-–∑–∞–ø—Ä–æ—Å–æ–≤
  const oldXHR = window.XMLHttpRequest;
  function newXHR() {
    const realXHR = new oldXHR();
    realXHR.addEventListener('load', function() {
      setTimeout(initOverlays, 100);
    });
    return realXHR;
  }
  window.XMLHttpRequest = newXHR;
})();